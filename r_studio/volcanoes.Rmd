---
title: "volcanoes"
---

## Настройка вывода сообщений и данных

```{r Настройка, include=TRUE}
knitr::opts_chunk$set(dev = 'png', warning = FALSE) 
options(digits = 4) 
```

## Подключение необходимых библиотек

```{r Подключение библиотек, message=FALSE, warning=FALSE}
library(tidyverse) # трансформация и визуализация данных
library(forecast) # анализ временных рядов и прогнозирование
library(scales) # Форматирование осей на графиках ggplot2
library(stringr)  # Работа с текстовыми строками
library(lubridate) # Обработка дат
library(readxl) # Чтение из Excel
```

## Загрузка данных и подготовка к анализу

**Загрузка источника данных:**

```{r, message=FALSE, warning=FALSE}
vol1 <- read_excel('./time_series.xlsx', sheet = '8')
view (vol1)
```

Удалось загрузить источник данных, содержащий информацию о ежемесячном объёме выбросов углекислого газа в атмосферу вулканом Мауна-Лоа в миллионных долях. Данные представлены в виде таблицы, которая содержит два столбца: дата проведения исследования и результаты измерения. Во время загрузки источника данных случайным образом добавилось 3 лишних столбца, которые не представляют из себя никакой статистической ценности, и поэтому требуют удаления. 
Также можно заявить, что в файле представлен временной ряд, так как в нём содержится статистический материал о значении исследуемых параметров в моменты времени с равными промежутками, что подтверждает тот факт, что данные могут быть подвергнуты анализу и процедуре прогнозирования. Тем не менее, для проведения операций над данными они должны быть приведены к удобной форме.

**Удаление лишних столбцов в таблице:**

```{r}
vol <- vol1 [,c(1,2)]
view (vol)
```

Теперь в наш источник данных лишён всех ненужных столбцов и готов к обработке.

**Переименуем столбцы в таблице:**

```{r}
colnames(vol)[1] <- "Date"
colnames(vol)[2] <- "CO2"
view (vol)
```

Теперь столбцы в таблице имеют краткие и информативные заголовки.

**Проверка данных на наличие выбросов и аномалий:**

```{r}
summary(vol)
```

Статистический анализ показал, что аномалии и выбросы в источнике данных отсутствуют. Нет аномально маленьких и аномально больших величин, а медиана совпала со средним значением, что говорит о качестве предоставленной нам информации. Данные готовы к анализу.

## Анализ данных


**Создание временного ряда из исследуемых данных:**

```{r}
vol_first <- 
  vol %>%
  summarize(year = year(first(Date)),
            month = month(first(Date)))

vol_ts <- 
  ts(data = vol$CO2, frequency = 12,
            start = c(vol_first$year, vol_first$month))

vol_d <- vol_ts %>% 
  decompose(type = 'additive')

autoplot(vol_ts) +
  labs (x="Дата", y="СО2, pmm", title="Объём выбросов углекислого газа вулканом", color = NULL)+
  autolayer (trendcycle(vol_d), series = "Тренд")
```


Данный временной ряд обладает чёткими возрастающим аддитивным трендом и аддитивной сезонностью. Исходя из найденных компонентов ряда, мы можем сделать вывод о том, что в этом случае подойдут модели прогнозирования, которые учитывают и сезонность, и тренд. Также будет справедливо заявить, что весь период временного ряда может быть подвергнут анализу по причине отсутствия каких-либо аномалий и выбросов на всём его протяжении. 

Скорее всего, существование двух ранее указанных компонентов временного ряда объясняется наличием у вулканов сезонным ритмом тепловой радиации и тем фактом, что рассматриваемый вулкан является действующим, и когда-нибудь он постепенно достигнет своего потенциала и начнёт извергаться.

**Выделение компонентов из временного ряда:**

```{r}
autoplot(vol_d)+
  labs(title = 'Компоненты временного ряда',
       x = NULL)
```

Посмотрев более подробно на каждый из компонентов временного ряда, мы можем заявить, что аддитивные тренд и сезонность выражены крайне ярко, а также остатки ничтожны, что свидетельствует о сильной цикличности наблюдаемого явления. Помимо этого, удаётся установить, что длина цикла равна 1-ому году.

Можно сделать вывод о том, что для формирования прогноза понадобятся модели, которые учитывают и тренд, и сезонность временного ряда. Этим условиям удовлетворяет модель Хольта-Винтерса, также можно попробовать использовать модель сезонного наивного прогноза.

## Выбор модели прогнозирования

В данном разделен будут проанализированы две модели прогнозирования для исследуемого временного ряда 

**Создание модели наивного сезонного прогноза на основе исследуемого временного ряда и её визуализация:**

```{r}
autoplot(vol_ts) +
  autolayer(snaive(vol_ts, h=12),
    series="Seasonal naïve", PI=FALSE)+
  labs (color = NULL, x = "Дата", y = "CO2, ppm", title ="Прогноз на 1 год с помощью сезонного наивного прогноза")
  
```

Как можно увидеть, сезонная наивная модель неплохо справилась со своими задачами. Она хорошо повторила паттерн графика факта. Тем не менее, без анализа её ошибок на обучающем и тестовом периодах сложно сделать какой-либо вывод о её справедливости.

**Создание модели прогноза Хольта-Винтерса на основе исследуемого временного ряда и её визуализация:**

Подберём коэффициенты с учётом ошибок в обучаемой периоде:

```{r}
vol_winters <- hw(vol_ts, beta = 0.1, gamma = 0.1, h = 12, seasonal = 'additive') 
summary(vol_winters)
```

Были подобраны коэффициенты, которые обеспечивают наименьшую среднеквадратичную ошибку модели (RMSE) в обучающем периоде. Бетта = 0,1 (тренд), Гамма = 0,1 (сезонность), а Альфа (ряд) подбирается автоматически. График прогноза на единичную длину сезонного цикла будет построен с учётом найденных коэффициентов.


```{r}
autoplot(vol_winters) +
  labs (title = "Прогноз на 1 год с помощью модели Хольта-Винтерса",
       x ="Дата", y ="CO, ppm")
```

Прогноз Хольта-Винтерса также хорошо справился со своей задачей - паттерн соответствует факту. Была задана аддитивная сезонность по причине результатов прошлых исследований временного ряда. Релевантность использования этого метода может быть подтверждена с помощью сравнения ошибок в обучающем и тестовом периодах с альтернативами. 

**Сравнение ошибок моделей на обучающем периоде:**

```{r}
error_learning <- rbind(accuracy(snaive(vol_ts)), 
             accuracy(vol_winters))
rownames(error_learning) <- c('Сезонный наивный прогноз', 'Метод Хольта-Винтерса')
error_learning
```

Метод Хольта-Винтерса показывет намного лучшие показатели в обучаемом периоде, нежели сезонный наивный метод. Следующим шагом будет проверка работы моделей в тестовом периоде.

**Ex-post прогноз:**

```{r}
# Построение моделей:
vol_ts_test <- window(vol_ts, start=1977,end=1980)
vol_sn_expost <- snaive(vol_ts_test, h=12)
vol_winters_expost <- hw(vol_ts_test, beta = 0.1, gamma = 0.1, h = 12, seasonal = 'additive') 
# Визуализация прогнозов:
vol_ts %>% window(start = 1977) %>%
  autoplot (series="Факт")+
    autolayer(vol_sn_expost$mean,  series = 'Сезонный наивный метод') +
    autolayer(vol_winters_expost$mean,  series = 'Метод Хольта-Винтерса') +
    labs(
       color = NULL, title = "Ex-post прогноз",
       x = "Дата", y = "CO2,ppm")
```

Согласно графику, в ex-post метод Хольта-Винтерса показывает крайне правдоподобную картину на тестовом периоде (последние 20% временного ряда). Нужен анализ ошибок моделей в тестовых периодах для окончательного выбора метода прогнозирования.

**Сравнение ошибок в тестовом периоде:**

```{r}
error_test <- 
rbind(
  accuracy(vol_sn_expost, vol_ts)['Test set',],
  accuracy(vol_winters_expost, vol_ts)['Test set',]) 
 rownames(error_test) <- c('Сезонный наивный прогноз', 'Метод Хольта-Винтерса')
error_test
```

Метод Хольта-Винтерса также демонстрирует потрясающие результаты на тестовом периоде, намного лучшие, чем у сезонного наивного метода. Именно он будет использован в качестве модели прогнозирования, используемой для прогнозирования объёма выбросов вулкана на два сезонных цикла вперёд.

## Финальный прогноз

```{r}
vol_winters_end <- hw(vol_ts, beta = 0.1, gamma = 0.1, h = 24, seasonal = 'additive') 

vol_ts %>%
autoplot(series="Факт") +
  autolayer(vol_winters_end$mean, series = 'Прогноз')+
    labs(title = 'Прогноз динамики выбросов углекислого газа вулканом на 2 года вперёд 
(два сезонных цикла)',
       color = NULL,
       x = "Дата", y = "CO2, ppm") 
```

**Таким образом, нам удалось получить надёжный прогноз динамики выбросов углекислого газа вулканом на 2 года вперёд. Прогноз был сформирован с предположением того, что в течение двух следующих лет вулкан не начнёт резкого извержения из-за изменения сейсмической активности. При сохранении прошлых условий тренд и сезонность временного ряда вряд ли изменятся, поэтому, в этом случае, корректировка прогноза не понадобится. Также корректировка будет лишней, так как выбросы углекислого газа вулканом не зависят от социальных факторов, таких как праздничные даты, выходные и т.д. Другими словами, данный прогноз можно считать точным и достоверным.**
